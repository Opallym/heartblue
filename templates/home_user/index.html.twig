{% extends 'base.html.twig' %}

{% block title %}Profil de {{ user.getName() }}{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ asset('css/profile.css') }}?v={{ "now"|date("YmdHis") }}">
{% endblock %}

{% block body %}
{% set isOwner = app.user and app.user.id == user.id %}

<div class="profile-page">

  <!-- HERO / HEADER -->
  <section class="profile-hero">
    <div class="hero-bg">
      <span class="blob b1"></span>
      <span class="blob b2"></span>
      <span class="blob b3"></span>
    </div>

    <div class="container hero-inner">
      <div class="avatar-wrap">
        <img
          src="{{ asset(user.getAvatar() ? 'uploads/avatars/' ~ user.getAvatar() : 'images/default-avatar.png') }}"
          alt="Avatar"
          class="avatar"
        >
        {% if isOwner %}
          <form class="avatar-edit" method="post" action="{{ path('profile_update_avatar') }}" enctype="multipart/form-data">
            <input type="hidden" name="_token" value="{{ csrf_token('update_avatar') }}">
            <label class="btn-upload">
              Changer
              <input type="file" name="avatar" accept="image/*" hidden onchange="this.form.submit()">
            </label>
          </form>
        {% endif %}
      </div>

      <div class="hero-info">
        <h1 class="name">
          {{ user.getName() }}{% if user.getAge() is not null %}, {{ user.getAge() }}{% endif %}
        </h1>
        <p class="location">
          {% if user.getCity() %}{{ user.getCity() }}{% if user.getCountry() %}, {{ user.getCountry() }}{% endif %}
          {% else %}{{ user.getCountry() }}{% endif %}
        </p>

        <div class="badges">
          {% for badge in user.getBadges() %}
            <span class="badge">üè∑Ô∏è {{ badge }}</span>
          {% else %}
            <em class="muted">Aucun badge pour le moment</em>
          {% endfor %}
        </div>

        <div class="actions">
          <a class="btn btn-primary" href="{{ path('app_message_new', {'to': user.id}) }}">Message</a>
          <a class="btn btn-outline" href="{{ path('app_favorite_toggle', {'id': user.id}) }}">Favoris</a>

          {% if isOwner %}
          {% endif %}
        </div>

        {% if isOwner %}
          <form id="quick-badges" class="inline-form" method="post" action="{{ path('profile_badge_add') }}">
            <input type="hidden" name="_token" value="{{ csrf_token('badge_add') }}">
            <input class="chip-input" type="text" name="badge" placeholder="Ajouter un badge (ex: 'Organisateur', 'D√©butant rando')">
            <button class="btn btn-small">Ajouter</button>
          </form>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="card-section about-section">
    <div class="container">
      <div class="section-head">
        <h2>√Ä propos de moi</h2>
        {% if isOwner %}
          <button class="link-edit" type="button" data-target="#form-about">Modifier</button>
        {% endif %}
      </div>

      <p class="about-text">
        {{ user.getAbout() ?: 'Pr√©sente-toi en quelques lignes : ton ambiance, ton rythme, ce que tu recherches‚Ä¶' }}
      </p>

      {% if isOwner %}
        <form id="form-about" class="edit-form hidden" method="post" action="{{ path('profile_update_about') }}">
          <input type="hidden" name="_token" value="{{ csrf_token('profile_update_about') }}">
          <textarea class="form-control" name="about" rows="4" placeholder="√âcris quelque chose‚Ä¶">{{ user.getAbout() }}</textarea>
          <div class="form-actions">
            <button class="btn btn-save">Enregistrer</button>
            <button class="btn btn-cancel" type="button" data-close="#form-about">Annuler</button>
          </div>
        </form>
      {% endif %}
    </div>
  </section>

  <!-- INTERESTS -->
  <section class="card-section interests-section">
    <div class="container">
      <div class="section-head">
        <h2>Mes centre d'interet</h2>
        {% if isOwner %}
          <button class="link-edit" type="button" data-target="#form-interests">Modifier</button>
        {% endif %}
      </div>

      <div class="chips">
        {% for interest in user.getInterests() %}
          <span class="chip">üéØ {{ interest }}</span>
        {% else %}
          <em class="muted">Ajoute tes centres d‚Äôint√©r√™t (rando, escalade, volley, caf√©-jeux‚Ä¶)</em>
        {% endfor %}
      </div>

      {% if isOwner %}
        <form id="form-interests" class="edit-form hidden" method="post" action="{{ path('profile_update_interests') }}">
          <input type="hidden" name="_token" value="{{ csrf_token('profile_update_interests') }}">
          <input class="form-control" type="text" name="interests" value="{{ user.getInterests()|join(', ') }}"
                 placeholder="Ex: rando, beach-volley, escape game">
          <div class="form-actions">
            <button class="btn btn-save">Enregistrer</button>
            <button class="btn btn-cancel" type="button" data-close="#form-interests">Annuler</button>
          </div>
        </form>
      {% endif %}
    </div>
  </section>

  <!-- GALLERY -->
  <section class="card-section gallery-section">
    <div class="container">
      <div class="section-head">
        <h2>Galerie</h2>
      </div>

      <div class="gallery-slider">
        <button class="slider-btn prev" aria-label="Pr√©c√©dent">‚Äπ</button>
        <div class="slides">
          {% for photo in user.getGallery() %}
            <div class="slide"><img src="{{ asset('uploads/gallery/' ~ photo) }}" alt="Galerie"></div>
          {% else %}
            <div class="slide"><img src="{{ asset('images/placeholder-gallery.jpg') }}" alt="Galerie"></div>
          {% endfor %}
        </div>
        <button class="slider-btn next" aria-label="Suivant">‚Ä∫</button>
      </div>

      {% if isOwner %}
        <form class="edit-form" method="post" action="{{ path('profile_gallery_add') }}" enctype="multipart/form-data">
          <input type="hidden" name="_token" value="{{ csrf_token('gallery_add') }}">
          <label class="btn btn-outline file-inline">
            Ajouter des photos
            <input type="file" name="photos[]" accept="image/*" multiple hidden onchange="this.form.submit()">
          </label>
        </form>
      {% endif %}
    </div>
  </section>

  <!-- INSIGHTS (√† la place de taille/poids) -->
  <section class="card-section insights-section">
    <div class="container">
      <div class="section-head">
        <h2>Mes infos cl√©s</h2>
        {% if isOwner %}
          <button class="link-edit" type="button" data-target="#form-core">Modifier</button>
        {% endif %}
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-icon">üìÖ</span>
          <span class="stat-label">Activit√©s cr√©√©es</span>
          <span class="stat-value">{{ user.getActivities()|length }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-icon">üí°</span>
          <span class="stat-label">Centres d‚Äôint√©r√™t</span>
          <span class="stat-value">{{ user.getInterests()|length }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-icon">üìç</span>
          <span class="stat-label">Ville</span>
          <span class="stat-value">{{ user.getCity() ?: '‚Äî' }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-icon">üè∑Ô∏è</span>
          <span class="stat-label">Badges</span>
          <span class="stat-value">{{ user.getBadges()|length }}</span>
        </div>
      </div>

      {% if isOwner %}
        <form id="form-core" class="edit-form hidden" method="post" action="{{ path('profile_update_core') }}">
          <input type="hidden" name="_token" value="{{ csrf_token('profile_update_core') }}">
          <div class="grid-2">
            <div>
              <label for="name">Nom</label>
              <input id="name" class="form-control" type="text" name="name" value="{{ user.getName() }}" required>
            </div>
            <div>
              <label for="age">√Çge</label>
              <input id="age" class="form-control" type="number" name="age" min="18" max="100" value="{{ user.getAge() }}">
            </div>
            <div>
              <label for="city">Ville</label>
              <input id="city" class="form-control" type="text" name="city" value="{{ user.getCity() }}">
            </div>
            <div>
              <label for="country">Pays</label>
              <input id="country" class="form-control" type="text" name="country" value="{{ user.getCountry() }}">
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-save">Enregistrer</button>
            <button class="btn btn-cancel" type="button" data-close="#form-core">Annuler</button>
          </div>
        </form>
      {% endif %}
    </div>
  </section>

</div>

{% endblock %}

{% block javascripts %}
<script>
// Toggle affichage des formulaires inline
document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-target]');
  if (btn) {
    const sel = btn.getAttribute('data-target');
    const form = document.querySelector(sel);
    if (form) form.classList.toggle('hidden');
  }
  const closeBtn = e.target.closest('[data-close]');
  if (closeBtn) {
    const sel = closeBtn.getAttribute('data-close');
    const form = document.querySelector(sel);
    if (form) form.classList.add('hidden');
  }
});

// Slider
(function(){
  const container = document.querySelector('.slides');
  const slides = document.querySelectorAll('.slide');
  const prev = document.querySelector('.prev');
  const next = document.querySelector('.next');
  let i = 0;
  function show(idx){
    if (!container || slides.length === 0) return;
    i = (idx + slides.length) % slides.length;
    container.style.transform = 'translateX(' + (-i * 100) + '%)';
  }
  prev && prev.addEventListener('click', () => show(i - 1));
  next && next.addEventListener('click', () => show(i + 1));
  show(0);
})();
</script>
{% endblock %}
