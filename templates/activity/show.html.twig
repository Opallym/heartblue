{% extends 'base.html.twig' %}

{% block title %}Activit√©s{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="{{ asset('css/activity-show.css') }}?v={{ 'now'|date('YmdHis') }}">
{% endblock %}
{% block body %}
<div class="activity-view">

  {# HERO avec image de couverture #}
  <section class="av-hero"
           style="--av-cover: url('{{ asset(activity.coverPath|default('images/placeholders/activity.jpg')) }}')">
    <div class="container av-hero-inner">
      {% if activity.category %}
        <span class="av-chip av-chip-cat">{{ activity.category }}</span>
      {% endif %}

      <h1 class="av-title">{{ activity.title }}</h1>

      <ul class="av-meta">
        {% if activity.location %}
          <li>üìç <a class="av-link"
                   href="https://www.google.com/maps/search/?api=1&query={{ activity.location|url_encode }}"
                   target="_blank" rel="noopener">{{ activity.location }}</a></li>
        {% endif %}
        <li>
          üìÖ <time id="av-time" datetime="{{ activity.date ? activity.date|date('c') : '' }}">
              {{ activity.date ? activity.date|date('d M Y, H:i') : 'Bient√¥t' }}
          </time>
        </li>
        <li id="av-countdown" data-date="{{ activity.date ? activity.date|date('c') : '' }}"></li>
      </ul>

      <div class="av-actions">
        <a href="{{ path('app_activity_index') }}" class="btn btn-outline">‚Üê Retour</a>

        {% if app.user and (app.user == activity.createdBy or 'ROLE_ADMIN' in app.user.roles) %}
          <a href="{{ path('app_activity_edit', {'id': activity.id}) }}" class="btn btn-primary">Modifier</a>
          {{ include('activity/_delete_form.html.twig') }}
        {% endif %}

        <button type="button" class="btn btn-ghost" id="av-share">Partager</button>
      </div>
    </div>
    <div class="av-overlay"></div>
  </section>

  <div class="container av-grid">
    <!-- Colonne principale -->
    <div class="av-main">
      <section class="av-card">
        <h2>√Ä propos de l‚Äôactivit√©</h2>
        <p class="av-desc">
          {{ activity.description ?: "L'organisateur n'a pas encore ajout√© de description d√©taill√©e." }}
        </p>
      </section>
    </div>

    <!-- Colonne lat√©rale -->
    <aside class="av-side">
      <section class="av-card">
        <h3>D√©tails</h3>
        <div class="av-detail">
          <span class="av-label">Quand</span>
          <span class="av-value">
            <time>{{ activity.date ? activity.date|date('d M Y, H:i') : 'Bient√¥t' }}</time>
          </span>
        </div>
        <div class="av-detail">
          <span class="av-label">O√π</span>
          <span class="av-value">
            {% if activity.location %}
              <a class="av-link"
                 href="https://www.google.com/maps/search/?api=1&query={{ activity.location|url_encode }}"
                 target="_blank" rel="noopener">{{ activity.location }}</a>
            {% else %} ‚Äî {% endif %}
          </span>
        </div>
        <div class="av-detail">
          <span class="av-label">Cat√©gorie</span>
          <span class="av-value">{% if activity.category %}<span class="av-chip">{{ activity.category }}</span>{% else %}‚Äî{% endif %}</span>
        </div>
      </section>

      {% set organizer = activity.createdBy ?? null %}
      <section class="av-card">
        <h3>Organisateur</h3>
        <div class="av-organizer">
          <img class="av-avatar"
               src="{{ asset(organizer and organizer.avatar ? 'uploads/avatars/' ~ organizer.avatar : 'images/default-avatar.png') }}"
               alt="Organisateur">
          <div>
            <div class="av-org-name">{{ organizer ? organizer.name : 'Utilisateur' }}</div>
            {% if organizer and organizer.city %}
              <div class="av-org-city">üìç {{ organizer.city }}{% if organizer.country %}, {{ organizer.country }}{% endif %}</div>
            {% endif %}
          </div>
        </div>
      </section>
    </aside>
  </div>
</div>

{% endblock %}
{% block javascripts %}
<script>
(function(){
  // Partage
  const shareBtn = document.getElementById('av-share');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      const url = window.location.href;
      const title = document.querySelector('.av-title')?.textContent?.trim() || 'Activit√©';
      try {
        if (navigator.share) {
          await navigator.share({ title, url });
        } else {
          await navigator.clipboard.writeText(url);
          shareBtn.textContent = 'Lien copi√© ‚úî';
          setTimeout(() => shareBtn.textContent = 'Partager', 1500);
        }
      } catch (e) {}
    });
  }

  // Compte √† rebours
  const cd = document.getElementById('av-countdown');
  const dateStr = cd?.dataset.date || '';
  if (cd && dateStr) {
    const target = new Date(dateStr).getTime();
    const tick = () => {
      const now = Date.now();
      const diff = target - now;
      if (isNaN(target)) { cd.textContent = ''; return; }
      if (diff <= 0) { cd.textContent = '‚è± En cours ou termin√©'; return; }
      const d = Math.floor(diff / (24*3600e3));
      const h = Math.floor((diff % (24*3600e3)) / 3600e3);
      const m = Math.floor((diff % 3600e3) / 60e3);
      cd.textContent = `‚è≥ Dans ${d}j ${h}h ${m}m`;
    };
    tick();
    setInterval(tick, 30e3);
  }
})();
</script>
{% endblock %}

